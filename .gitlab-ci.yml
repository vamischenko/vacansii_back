stages:
  - build
  - test
  - code-quality
  - security
  - deploy

variables:
  PHP_VERSION: "8.1"
  POSTGRES_DB: vacancy_test
  POSTGRES_USER: vacancy_user
  POSTGRES_PASSWORD: vacancy_password
  POSTGRES_HOST: postgres
  DOCKER_DRIVER: overlay2

# Кеширование зависимостей Composer
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/
    - .composer-cache/

# Базовый образ для PHP задач
.php-base:
  image: php:${PHP_VERSION}
  before_script:
    - apt-get update -qq && apt-get install -y -qq git libpq-dev libzip-dev unzip
    - docker-php-ext-install pdo pdo_pgsql zip
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - export COMPOSER_CACHE_DIR=.composer-cache
    - composer install --prefer-dist --no-progress --no-interaction

# ==================== BUILD ====================

build:composer:
  extends: .php-base
  stage: build
  script:
    - composer install --prefer-dist --no-progress --no-interaction
    - composer validate --strict
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour

# ==================== TEST ====================

test:unit:
  extends: .php-base
  stage: test
  services:
    - postgres:14
  dependencies:
    - build:composer
  variables:
    DB_DSN: "pgsql:host=postgres;port=5432;dbname=${POSTGRES_DB}"
    DB_USERNAME: ${POSTGRES_USER}
    DB_PASSWORD: ${POSTGRES_PASSWORD}
  script:
    - cp .env.example .env
    - echo "DB_DSN=${DB_DSN}" >> .env
    - echo "DB_USERNAME=${DB_USERNAME}" >> .env
    - echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
    - php yii migrate --interactive=0
    - vendor/bin/codecept run unit --coverage --coverage-xml
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: tests/_output/coverage.xml
    paths:
      - tests/_output/
    expire_in: 1 week

test:functional:
  extends: .php-base
  stage: test
  services:
    - postgres:14
  dependencies:
    - build:composer
  variables:
    DB_DSN: "pgsql:host=postgres;port=5432;dbname=${POSTGRES_DB}"
    DB_USERNAME: ${POSTGRES_USER}
    DB_PASSWORD: ${POSTGRES_PASSWORD}
  script:
    - cp .env.example .env
    - echo "DB_DSN=${DB_DSN}" >> .env
    - echo "DB_USERNAME=${DB_USERNAME}" >> .env
    - echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
    - php yii migrate --interactive=0
    - vendor/bin/codecept run functional
  artifacts:
    paths:
      - tests/_output/
    expire_in: 1 week
    when: on_failure

test:api:
  extends: .php-base
  stage: test
  services:
    - postgres:14
  dependencies:
    - build:composer
  variables:
    DB_DSN: "pgsql:host=postgres;port=5432;dbname=${POSTGRES_DB}"
    DB_USERNAME: ${POSTGRES_USER}
    DB_PASSWORD: ${POSTGRES_PASSWORD}
  script:
    - cp .env.example .env
    - echo "DB_DSN=${DB_DSN}" >> .env
    - echo "DB_USERNAME=${DB_USERNAME}" >> .env
    - echo "DB_PASSWORD=${DB_PASSWORD}" >> .env
    - php yii migrate --interactive=0
    - php yii seed/run
    - vendor/bin/codecept run api
  artifacts:
    paths:
      - tests/_output/
    expire_in: 1 week
    when: on_failure

# ==================== CODE QUALITY ====================

code-quality:syntax:
  extends: .php-base
  stage: code-quality
  dependencies:
    - build:composer
  script:
    - find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
  allow_failure: false

code-quality:phpcs:
  extends: .php-base
  stage: code-quality
  dependencies:
    - build:composer
  script:
    - |
      if [ -f "phpcs.xml" ]; then
        vendor/bin/phpcs
      else
        echo "phpcs.xml not found, skipping"
      fi
  allow_failure: true

code-quality:phpstan:
  extends: .php-base
  stage: code-quality
  dependencies:
    - build:composer
  script:
    - |
      if [ -f "phpstan.neon" ]; then
        vendor/bin/phpstan analyse
      else
        echo "phpstan.neon not found, skipping"
      fi
  allow_failure: true

# ==================== SECURITY ====================

security:composer-audit:
  extends: .php-base
  stage: security
  dependencies:
    - build:composer
  script:
    - composer audit
  allow_failure: true

security:dependency-check:
  extends: .php-base
  stage: security
  dependencies:
    - build:composer
  script:
    - echo "Checking for known vulnerabilities in dependencies..."
    - composer show --direct | grep -i security || true
  allow_failure: true

# ==================== DEPLOY ====================

deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - eval $(ssh-agent -s)
    - echo "$STAGING_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $STAGING_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $STAGING_USER@$STAGING_HOST << 'EOF'
        cd /var/www/vacancy-api
        git fetch origin
        git checkout $CI_COMMIT_REF_NAME
        git pull origin $CI_COMMIT_REF_NAME
        composer install --no-dev --optimize-autoloader
        php yii migrate --interactive=0
        php yii cache/flush-all
        docker-compose up -d --force-recreate
      EOF
    - echo "Deployed to staging successfully"
  environment:
    name: staging
    url: https://staging-api.yourdomain.com
  only:
    - develop
  when: manual

deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - eval $(ssh-agent -s)
    - echo "$PRODUCTION_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $PRODUCTION_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_HOST << 'EOF'
        cd /var/www/vacancy-api
        git fetch --tags
        git checkout $CI_COMMIT_TAG
        composer install --no-dev --optimize-autoloader
        php yii migrate --interactive=0
        php yii cache/flush-all
        docker-compose pull
        docker-compose up -d --force-recreate
      EOF
    - echo "Deployed to production successfully"
  environment:
    name: production
    url: https://api.yourdomain.com
  only:
    - tags
  when: manual

# ==================== DOCKER BUILD ====================

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -f docker/php/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - |
      if [ "$CI_COMMIT_REF_NAME" == "main" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  only:
    - main
    - develop
    - tags
  when: manual

# ==================== NOTIFICATIONS ====================

notify:success:
  stage: .post
  image: alpine:latest
  script:
    - echo "Pipeline completed successfully for $CI_COMMIT_REF_NAME"
    # Можно добавить отправку уведомлений в Slack, Telegram и т.д.
  when: on_success
  only:
    - main
    - develop

notify:failure:
  stage: .post
  image: alpine:latest
  script:
    - echo "Pipeline failed for $CI_COMMIT_REF_NAME"
    # Можно добавить отправку уведомлений об ошибке
  when: on_failure
  only:
    - main
    - develop
