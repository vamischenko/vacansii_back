name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PHP_VERSION: '8.3'
  COMPOSER_VERSION: '2'

jobs:
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #
  #   services:
  #     postgres:
  #       image: postgres:14
  #       env:
  #         POSTGRES_DB: vacancy_test
  #         POSTGRES_USER: vacancy_user
  #         POSTGRES_PASSWORD: vacancy_password
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #
  #     - name: Setup PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: ${{ env.PHP_VERSION }}
  #         extensions: mbstring, intl, pdo, pdo_pgsql, curl, json, zip
  #         coverage: xdebug
  #         tools: composer:v${{ env.COMPOSER_VERSION }}
  #
  #     - name: Get composer cache directory
  #       id: composer-cache
  #       run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
  #
  #     - name: Cache composer dependencies
  #       uses: actions/cache@v3
  #       with:
  #         path: ${{ steps.composer-cache.outputs.dir }}
  #         key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-composer-
  #
  #     - name: Install dependencies
  #       run: composer install --prefer-dist --no-progress --no-interaction
  #
  #     - name: Setup environment
  #       run: |
  #         cp .env.example .env
  #         echo "DB_DSN=pgsql:host=localhost;port=5432;dbname=vacancy_test" >> .env
  #         echo "DB_USERNAME=vacancy_user" >> .env
  #         echo "DB_PASSWORD=vacancy_password" >> .env
  #
  #     - name: Run migrations
  #       run: php yii migrate --interactive=0
  #
  #     - name: Run unit tests
  #       run: vendor/bin/codecept run unit --coverage --coverage-xml
  #
  #     - name: Run functional tests
  #       run: vendor/bin/codecept run functional
  #
  #     - name: Run API tests
  #       run: vendor/bin/codecept run api
  #
  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecept-action@v3
  #       with:
  #         files: ./tests/_output/coverage.xml
  #         fail_ci_if_error: false

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl
          tools: composer:v${{ env.COMPOSER_VERSION }}, phpcs, phpstan

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Check PHP syntax
        run: find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l

      - name: Run PHP_CodeSniffer (if configured)
        run: |
          if [ -f "phpcs.xml" ]; then
            vendor/bin/phpcs || true
          else
            echo "phpcs.xml not found, skipping"
          fi
        continue-on-error: true

  security:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v${{ env.COMPOSER_VERSION }}

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Security check
        run: composer audit || true

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/php/Dockerfile
          push: false
          tags: vacancy-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /var/www/vacancy-api
            git pull origin main
            docker-compose pull
            docker-compose up -d --force-recreate
            docker-compose exec -T php php yii migrate --interactive=0

      - name: Notify deployment
        if: success()
        run: |
          echo "Deployment successful!"
          # Здесь можно добавить отправку уведомлений в Slack, Discord и т.д.

      - name: Notify failure
        if: failure()
        run: |
          echo "Deployment failed!"
          # Здесь можно добавить отправку уведомлений об ошибке
